{% extends "account/base.html" %}
{% load setting from web_extras %}
{% load static from static %}

{% block content %}
<section id="account-billing-plan" class="box-section">
	<h3>Premium plan</h3>
	<div class="inner">
		{% if customer.subscription %}

			<p>
				{% if customer.subscription.cancel_at_period_end %}
				<p>
					Your subscription ends on {{ customer.subscription.current_period_end }}
				</p>
				<form method="POST" action="{% url 'premium_subscribe' %}">
					{% csrf_token %}
					<input type="hidden" name="plan" value="{{ customer.subscription.plan.stripe_id }}"/>
					<button type="submit" name="cancel" class="btn btn-primary">Reactivate</button>
				</form>
				{% else %}
				<p>
					You're premium! Cool!
				</p>
				<form method="POST" action="{% url 'premium_cancel' %}">
					{% csrf_token %}
					<button type="submit" name="cancel" class="btn btn-danger">Cancel subscription</button>
				</form>
				{% endif %}
			</p>

		{% else %}
			You're not premium :(

			{% if payment_methods %}
				<form method="POST" action="{% url 'premium_subscribe' %}">
					{% csrf_token %}
					<input type="hidden" name="plan" value="pro-monthly"/>
					<button type="submit" name="subscribe">Subscribe</button>
				</form>
			{% else %}
				<a href="{% url 'premium' %}">Check out premium</a>
			{% endif %}

		{% endif %}

		{% if stripe_debug %}
		<hr/>
		<ul>
			<li><strong>Customer ID:</strong> <code>{{ customer.stripe_id }}</code></li>
			{% if customer.subscription %}
				<li><strong>Subscription ID:</strong> <code>{{ customer.subscription.stripe_id }}</code></li>
				<li><strong>Plan ID:</strong> <code>{{ customer.subscription.plan.stripe_id }}</code></li>
			{% endif %}
		</ul>
		{% endif %}

	</div>
</section>

<section id="account-billing-payment-methods" class="box-section">
	<h3>Payment Methods</h3>
	<div class="inner">
		{% include "snippets/noscript.html" %}

		{% if not customer.default_source %}
			<p class="alert alert-info">You do not have a default payment method set up.</p>
		{% endif %}

		<p>
			All credit card information is stored and handled by <a href="https://stripe.com/" target="_blank">Stripe</a>, our payment processor.
			HSReplay.net does not ever see your credit card number.
		</p>

		{% if payment_methods %}
			<ul id="account-billing-creditcard-list">
			{% for source in payment_methods %}
				<li
					class="creditcard {% if source == customer.default_source %}card-default{% endif %}"
					aria-label="{{ source.brand }} ending in {{ source.last4 }}"
					data-brand="{{ source.brand }}"
				>
					{% if source == customer.default_source %}<span class="label label-success">Default</span>{% endif %}
					<h4 class="card-title">
						{{ source.brand }} &bull;&bull;&bull;&bull; {{ source.last4 }}
					</h4>

					<span class="card-expiry">Expires <time>{{ source.exp_month }}/{{ source.exp_year }}</time></span>

					{% if stripe_debug %}<p><code>{{ source.stripe_id }}</code></p>{% endif %}

					<form method="POST" action="{% url 'billing_update_card' %}" class="card-remove-form">
						{% csrf_token %}
						<input type="hidden" name="stripe_id" value="{{ source.stripe_id }}"/>
						<button type="submit" name="delete" class="btn btn-danger">Remove card</button>
						{% if source != customer.default_source %}
							<button type="submit" name="set_default" class="btn btn-primary">Set as default</button>
						{% endif %}
					</form>
				</li>
			{% endfor %}
			</ul>
		{% endif %}

		<p>
			<form method="POST" action="{% url 'billing_methods' %}">
				{% csrf_token %}
				<script
					type="text/javascript" src="https://checkout.stripe.com/checkout.js" class="stripe-button"
					data-key="{% setting 'STRIPE_PUBLIC_KEY' %}"
					data-image="{% static 'images/hsreplay-thumbnail.png' %}"
					data-name="HSReplay.net"
					{% if user.email %}data-email="{{ user.email }}"{% endif %}
					data-locale="auto"
					data-description="Add a credit card"
					data-label="Add a credit card"
					data-panel-label="Add card"
				></script>
			</form>
		</p>
	</div>
</section>

<section id="account-payment-history" class="box-section">
	<h3>Payment History</h3>

	<div class="inner">
		{% if customer.invoices.count %}
		<table class="table table-striped">
			<thead>
				<tr>
					<th>Transaction ID</th>
					<th>Date</th>
					<th>Amount</th>
					{% if stripe_debug %}<th>Stripe ID</th>{% endif %}
				</tr>
			</thead>
			{% for invoice in customer.invoices.all %}
				<tr>
					<td class="fixed">#{{ invoice.id }}</td>
					<td>{{ invoice.date|date:"M d" }}</td>
					<td colspan=2>
						{% if invoice.paid and invoice.total > 0 %}
							<p>
								<span class="label label-success">Paid</span> ${{ invoice.total|floatformat:"2" }}
							</p>
						{% endif %}

						{% if invoice.paid and invoice.total < 0 %}
							<p>
								<span class="label label-success">Credit</span> ${{ invoice.total|floatformat:"2" }}
							</p>
						{% endif %}
					</td>
					{% if stripe_debug %}<td><code>{{ invoice.stripe_id }}</code></td>{% endif %}
				</tr>
			{% endfor %}
		</table>
		{% else %}
			<p>You have no recorded payments.</p>
		{% endif %}
	</div>
</section>
{% endblock %}
