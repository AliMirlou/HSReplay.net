{% extends "socialaccount/base.html" %}
{% load socialaccount staticfiles %}
{% load feature from features %}
{% load blocktrans trans from i18n %}

{% block content %}

<section class="box-section">
<h3>{% trans "Connected accounts" %}</h3>
<div class="inner">

{% if form.accounts %}
	<p>
		{% blocktrans %}The following social accounts are connected to your HSReplay.net account.
		You may log in with any connected Blizzard account.{% endblocktrans %}
	</p>
	<table id="account-connections">
		{% for base_account in form.accounts %}
			{% with base_account.get_provider_account as account %}
			<tr>
				<th>
					{% if account.get_brand.id == "battlenet" %}
						<img src="{% static 'images/socialauth/battlenet.png' %}" style="width: 20px; height: 21px;"/>
						{{ account }}
					{% elif account.get_brand.id == "discord" %}
						<img src="{% static 'images/socialauth/discord.png' %}" style="width: 21px; height: 21px;"/>
						{{ account }}#{{ base_account.extra_data.discriminator }}
					{% elif account.get_brand.id == "twitch" %}
						<img src="{% static 'images/socialauth/twitch.png' %}" style="width: 21px; height: 21px;"/>
						{{ account }}
					{% else %}
						<span class="socialaccount_provider {{ base_account.provider }} {{ account.get_brand.id }}">{{ account.get_brand.name }}</span>
						{{ account }}
					{% endif %}
				</th>
				<td>
					{% if account.get_brand.id == "battlenet" %}
						{% if base_account.extra_data.battletag != request.user.username %}
						<form method="POST" action="{% url 'account_make_primary' %}">
							{% csrf_token %}
							<input type="hidden" name="account" value="{{ base_account.id }}"/>
							<button type="submit" class="btn btn-xs btn-primary">Make primary</button>
						</form>
						{% else %}
							<span class="label label-primary">âœ” Primary account</span>
						{% endif %}
					{% endif %}
				</td>
				<td>
					{% if base_account.extra_data.battletag != request.user.username %}
					<form method="POST" action="{% url 'socialaccount_connections' %}">
						{% csrf_token %}
						<input type="hidden" name="account" value="{{ base_account.id }}"/>
						<button type="submit" class="btn btn-xs btn-danger">Remove</button>
					</form>
					{% endif %}
				</td>
			</tr>
			{% endwith %}
		{% endfor %}
	</table>
{% else %}
	<p>{% trans "You currently have no social network accounts connected to this account." %}</p>
{% endif %}
</div>
</section>

<section id="account-blizzard-link" class="box-section">
	<h3>{% trans "Connect with Blizzard" %}</h3>
	<div class="inner">
		<p>
			{% blocktrans %}Here, you can connect multiple Blizzard accounts to your HSReplay.net account.
			This lets you sign in with any of them.{% endblocktrans %}
		</p>

		<form method="GET" action="{% provider_login_url 'battlenet' %}">
			<input type="hidden" name="process" value="connect"/>

			<p>
				<label for="id_region">Region</label>
				<select name="region" id="id_region" class="sm">
					<option value="us">Americas (US)</option>
					<option value="eu">Europe (EU)</option>
					<option value="kr">Korea (KR)</option>
					<option value="sea">South East Asia (SEA)</option>
					<option value="tw">Taiwan (TW)</option>
					<option value="cn">China (CN)</option>
				</select>
				</label>
			</p>

			<p>
				<a href="https://battle.net/en/?logout" target="_blank" rel="noopener" class="btn btn-default">{% trans "1. Sign out of Blizzard" %}</a>
				<button type="submit" class="btn btn-primary">{% trans "2. Connect a Blizzard account" %}</button>
			</p>

			<p class="alert alert-info">
				{% trans "Make sure to sign out of Blizzard before adding another account. This does not sign you out of HSReplay.net." %}
			</p>
		</form>
	</div>
</section>

<section id="account-discord-link" class="box-section">
	<h3>{% trans "Connect with Discord" %}</h3>
	<div class="inner">
		{% if premium %}
		<p>
			{% blocktrans %}As a subscriber, you have access to the exclusive <strong style="color:#dc9502">Premium Supporter</strong> role on <a href="https://discord.gg/hearthsim" target="_blank">our official Discord server</a>.
			Connect your Discord account here to do so.{% endblocktrans %}
		</p>

		<form method="GET" action="{% provider_login_url 'discord' %}">
			<input type="hidden" name="process" value="connect"/>
			<p>
				<button type="submit" class="btn btn-primary">{% trans "Connect a Discord account" %}</button>
			</p>
		</form>
		{% else %}

		<p>
			<a href="{% url 'premium' %}">Premium subscribers</a> can connect their Discord account and get
			a <strong style="color:#dc9502">special role</strong> on the <a href="https://discord.gg/hearthsim" target="_blank" rel="noopener">official HearthSim Discord</a>!
		</p>

		{% endif %}
	</div>
</section>

<section id="account-twitch-link" class="box-section">
	<h3>{% trans "Connect with Twitch" %}</h3>
	<div class="inner">

		<p>
			Do you stream Hearthstone on Twitch?
			Check out the <a href="https://articles.hsreplay.net/2017/10/26/twitch-extension-for-hearthstone-deck-tracker/">Twitch Extension for Hearthstone Deck Tracker</a>.
			Connect your account here to set it up!
		</p>

		<form method="GET" action="{% provider_login_url 'twitch' %}">
			<input type="hidden" name="process" value="connect"/>
			<p>
				<button type="submit" class="btn btn-primary">{% trans "Connect a Twitch account" %}</button>
			</p>
		</form>
	</div>
</section>

<section id="account-blizzard-accounts" class="box-section">
	<h3>{% trans "Hearthstone accounts" %}</h3>
	<div class="inner">
		<p>
			{% blocktrans %}We have automatically detected the following Hearthstone accounts and associated them with you.
			You can see statistics and upload your collection for any of these accounts.{% endblocktrans %}
		</p>
		{% if user.blizzard_accounts.count %}
			<ul class="list-group list-group-no-margin">
			{% for blizzard_account in user.blizzard_accounts.all %}
				<li class="list-group-item">
					<button
						data-target-url="/api/v1/account/unlink/?account_hi={{ blizzard_account.account_hi }}&account_lo={{ blizzard_account.account_lo }}"
						type="submit"
						class="btn btn-danger pull-right remove-blizzard-account-button"
					>
						Remove
					</button>
					<strong>{{ blizzard_account }}</strong>
					<div class="clearfix"></div>
				</li>
			{% endfor %}
			</ul>
			<script>
				(function () {
					var token = ("; " + document.cookie).split("; csrftoken=").pop().split(";").shift();
					var btns = document.querySelectorAll(".remove-blizzard-account-button");
					for (var i = 0; i < btns.length; i++) {
						var btn = btns[i];
						var url = btn.getAttribute("data-target-url");
						btn.onclick = function () {
							btn.setAttribute("disabled", "disabled");
							fetch(url, {
								method: "DELETE",
								credentials: "include",
								headers: {
									"X-CSRFToken": token,
								}
							}).then(function (response) {
								if (response.status !== 200) {
									throw new Error("Invalid response code");
								}
							}).then(function () {
								btn.parentNode.remove();
							})
							.catch(function (error) {
								btn.removeAttribute("disabled");
								console.error(error);
							});
						};
					}
				})();
			</script>
		{% else %}
		<p>
			You do not have any connected Hearthstone account.
			<a href="{% url 'downloads' %}">Download a Deck Tracker</a> and start uploading games!
		</p>
		{% endif %}
	</div>
</section>

{% include "socialaccount/snippets/login_extra.html" %}

{% endblock %}
